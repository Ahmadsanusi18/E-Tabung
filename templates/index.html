{% extends "base.html" %}
{% block content %}

<div class="py-8">
    <div class="mb-8">
        <h1 class="text-4xl font-righteous font-extrabold text-blue-900 tracking-tight">
             Laporan Tabungan Informatika
        </h1>
        <p class="text-gray-600 mt-2">Ringkasan status tabungan seluruh anggota dengan detail terbaru.</p>
        <div class="h-1 bg-cyan-500 w-20 mt-4 rounded-full"></div>
    </div>
    
<div class="mb-10">
    <div class="bg-indigo-500 p-6 rounded-xl shadow-xl hover:shadow-indigo-400/50 transition duration-500 ease-in-out transform hover:-translate-y-1">
        <div class="flex justify-between items-center">
            <h5 class="text-2xl font-semibold text-white">
                <i class="fa-solid fa-wallet mr-3"></i> Total Akumulasi Tabungan:
            </h5>
            <p class="text-4xl font-extrabold text-white tracking-wider">Rp {{ global_total | format_rupiah }}</p>
        </div>
    </div>
</div>

    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
        
        <div class="p-4 border-b border-gray-200 bg-gray-50">
            <h4 class="text-xl font-semibold text-blue-900">
                <i class="fa-solid fa-table-list mr-2"></i> Detail Tabungan Anggota
            </h4>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider text-center">No</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Nama Anggota</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider text-center">Minggu Terisi</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider text-right">Total Tabungan</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider text-center">Status</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider text-center">Aksi</th>
                    </tr>
                </thead>
            
                <tbody class="divide-y divide-gray-200">
                {% for row in data %}
                    <tr class="hover:bg-indigo-50 transition duration-150 ease-in-out"> 
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-500 text-center">{{ loop.index }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <i class="fa-solid fa-user-circle mr-2 text-cyan-500"></i> {{ row.member.name }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-cyan-600 text-center">{{ row.count }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-extrabold text-indigo-600 text-right">Rp {{ row.total | format_rupiah }}</td>

                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                            {% if row.notif %}
                            <span class="px-3 py-1 inline-flex items-center text-xs leading-5 font-semibold rounded-full bg-cyan-600 text-white shadow-md">
                                <i class="fa-solid fa-check-circle mr-1"></i> {{ row.notif }}
                            </span>
                            {% else %}
                            <span class="px-3 py-1 inline-flex items-center text-xs leading-5 font-semibold rounded-full bg-yellow-400 text-gray-900 shadow-md">
                                <i class="fa-solid fa-hourglass-half mr-1"></i> Belum Penuh
                            </span>
                            {% endif %}
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                            <div class="flex justify-center space-x-2">
                                <button
                                    class="text-indigo-600 hover:text-white font-medium transition duration-150 ease-in-out p-2 border border-indigo-600 rounded-lg hover:bg-indigo-600 
                                    {% if row.next_week is none %}opacity-50 cursor-not-allowed hover:bg-white hover:text-indigo-600{% endif %}"
                                    data-id="{{ row.member.id }}"
                                    data-name="{{ row.member.name }}"
                                    data-next-week="{{ row.next_week or '' }}"
                                    onclick="openAddModal(this)"
                                    {% if row.next_week is none %}disabled{% endif %}
                                >
                                    <i class="fa-solid fa-plus-circle"></i> 
                                </button>

                                <button
                                    class="text-cyan-600 hover:text-white font-medium transition duration-150 ease-in-out p-2 border border-cyan-600 rounded-lg hover:bg-cyan-600"
                                    data-id="{{ row.member.id }}"
                                    data-name="{{ row.member.name }}"
                                    onclick="openEditModal(this)"
                                >
                                    <i class="fa-solid fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="p-3 text-center text-sm text-gray-500 border-t border-gray-200 bg-gray-50">
            Data tabungan diperbarui secara real-time.
        </div>
    </div>
    
</div>

<div id="addModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden flex justify-center items-center">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4" onclick="event.stopPropagation()">
        
        <div class="border-b border-gray-200 p-6 flex justify-between items-center">
            <h2 class="text-2xl font-bold text-indigo-600">
                <i class="fa-solid fa-upload mr-3"></i> Input Tabungan Baru
            </h2>
            <button onclick="closeAddModal()" class="text-gray-500 hover:text-gray-800 transition">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
        </div>

        <div class="p-6 md:p-8">
            <p class="text-gray-600 mb-4">
                Untuk: <span id="memberName" class="font-bold text-cyan-600"></span>
            </p>

            <div class="bg-blue-50 border border-blue-300 text-blue-700 p-4 rounded-lg mb-6 flex items-start">
                <i class="fa-solid fa-info-circle mt-1 mr-3 text-blue-500 text-lg"></i>
                <div>
                    <p class="font-semibold">Informasi Penting:</p>
                    <p class="text-sm">Tabungan yang disimpan adalah senilai **Rp 10.000** per minggu.</p>
                </div>
            </div>

            <form id="addForm" method="POST" action="/add/MEMBER_ID_PLACEHOLDER">
                
                <div class="mb-6">
                    <label for="weekSelectModal" class="block text-lg font-medium text-gray-800 mb-2">
                        <i class="fa-solid fa-calendar-check mr-2 text-indigo-600"></i> Pilih Minggu ke-
                    </label>
                    
                    {# Input Hidden untuk mengirimkan nilai 'week' ke server #}
                    <input type="hidden" name="week" id="weekHiddenInput">
                    
                    {# Select yang hanya berfungsi sebagai DISPLAY #}
                    <select id="weekSelectModal" class="w-full bg-white text-gray-900 border border-gray-300 rounded-lg py-3 px-4 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base appearance-none shadow-inner pointer-events-none" required>
                        {# Opsi akan diisi oleh JavaScript #}
                    </select>

                    <p class="text-sm text-gray-500 mt-2" id="weekInstruction">Pilih minggu yang tersedia.</p>
                </div>

                <div class="mt-8">
                    <button type="submit" id="saveButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-indigo-400/50 transition duration-300 ease-in-out transform hover:scale-[1.01]">
                        <i class="fa-solid fa-save mr-2"></i> Simpan Tabungan (Rp 10.000)
                    </button>
                </div>
            </form>
        </div>
        
    </div>
</div>

<div id="editModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden flex justify-center items-center">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl mx-4" onclick="event.stopPropagation()">
        
        <div class="border-b border-gray-200 p-6 flex justify-between items-center bg-cyan-50">
            <h2 class="text-2xl font-bold text-cyan-700">
                <i class="fa-solid fa-edit mr-3"></i> Edit Riwayat Tabungan
            </h2>
            <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-800 transition">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
        </div>

        <div class="p-6 md:p-8">
            <p class="text-gray-600 mb-4">
                Mengedit Riwayat untuk: <span id="editMemberName" class="font-bold text-cyan-600"></span>
            </p>

            <div class="bg-yellow-50 border border-yellow-300 text-yellow-800 p-4 rounded-lg mb-6 flex items-start">
                <i class="fa-solid fa-exclamation-triangle mt-1 mr-3 text-yellow-600 text-lg"></i>
                <div>
                    <p class="font-semibold">Perhatian:</p>
                    <p class="text-sm">Fitur ini memungkinkan Anda untuk menghapus tabungan yang sudah tercatat (Rp 10.000) pada minggu tertentu.</p>
                </div>
            </div>

            <form id="editForm" method="POST" action="/edit/MEMBER_ID_PLACEHOLDER">
                
                <div class="mb-6">
                    <label for="weekEditSelect" class="block text-lg font-medium text-gray-800 mb-2">
                        <i class="fa-solid fa-calendar-minus mr-2 text-cyan-600"></i> Pilih Minggu yang Akan Dihapus
                    </label>
                    
                    <select name="week" id="weekEditSelect" class="w-full bg-white text-gray-900 border border-gray-300 rounded-lg py-3 px-4 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-base appearance-none shadow-inner" required>
                        <option value="" disabled selected>Memuat riwayat...</option>
                        {# Opsi akan diisi oleh JavaScript dari API #}
                    </select>

                    <p class="text-sm text-gray-500 mt-2" id="editInstruction">Data ini diambil dari riwayat tabungan yang sudah terisi.</p>
                </div>

                <div class="mt-8">
                    <button type="submit" id="deleteButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-red-400/50 transition duration-300 ease-in-out transform hover:scale-[1.01]">
                        <i class="fa-solid fa-trash-alt mr-2"></i> Hapus Tabungan Minggu Ini (Rp 10.000)
                    </button>
                </div>
            </form>
        </div>
        
    </div>
</div>

<script>
    // FUNGSI TAMBAH (ADD) - Kode Anda sebelumnya, dimodifikasi agar menggunakan parameter yang dilewatkan
function closeAddModal() {
    document.getElementById("addModal").classList.add("hidden");
}

function openAddModal(button) {
    const memberId = button.dataset.id;
    const memberName = button.dataset.name;
    const nextWeekRaw = button.dataset.nextWeek;
    
    const nextWeek = nextWeekRaw === "" || nextWeekRaw === "None"
        ? null 
        : parseInt(nextWeekRaw);

    document.getElementById("memberName").innerText = memberName;
    document.getElementById("addForm").action = "/add/" + memberId;

    const select = document.getElementById("weekSelectModal");
    const hiddenInput = document.getElementById("weekHiddenInput");
    const saveButton = document.getElementById("saveButton");
    const instruction = document.getElementById("weekInstruction");
    
    select.innerHTML = "";
    saveButton.disabled = false;
    instruction.classList.remove("text-red-500");

    if (nextWeek === null) {
        const opt = document.createElement("option");
        opt.text = "Semua 52 Minggu Sudah Terisi ðŸŽ‰";
        opt.selected = true;
        
        select.appendChild(opt);
        
        hiddenInput.value = "";
        saveButton.disabled = true;
        instruction.innerText = "Anggota ini telah menyelesaikan 52 minggu tabungan.";
        instruction.classList.add("text-red-500");
    } else {
        const opt = document.createElement("option");
        opt.value = nextWeek;
        opt.text = "Minggu ke-" + nextWeek;
        opt.selected = true;
        
        select.appendChild(opt);
        
        hiddenInput.value = nextWeek; 
        
        saveButton.disabled = false;
        instruction.innerText = "Minggu yang akan disimpan adalah Minggu ke-" + nextWeek + ".";
    }

    document.getElementById("addModal").classList.remove("hidden");
}

// FUNGSI BARU UNTUK EDIT/HAPUS
const editModal = document.getElementById('editModal');
const editMemberNameDisplay = document.getElementById('editMemberName');
const editForm = document.getElementById('editForm');
const weekEditSelect = document.getElementById('weekEditSelect');
const deleteButton = document.getElementById('deleteButton');

function closeEditModal() {
    editModal.classList.add("hidden");
}

function openEditModal(button) {
    const memberId = button.dataset.id;
    const memberName = button.dataset.name;

    editMemberNameDisplay.innerText = memberName;
    // Set action ke endpoint edit, yang akan menangani penghapusan berdasarkan minggu
    editForm.action = "/edit/" + memberId; 

    // Reset opsi dan status
    weekEditSelect.innerHTML = '<option value="" disabled selected>Memuat riwayat...</option>';
    deleteButton.disabled = true;

    editModal.classList.remove("hidden");
    
    // --- PANGGIL API UNTUK MENDAPATKAN RIWAYAT MINGGU TERISI ---
    // PENTING: Anda harus membuat endpoint API ini di backend Anda!
    // Contoh API: /api/filled_weeks/1 -> [{"week": 1, "date": "2025-01-05"}, ...]
    fetch(`/api/filled_weeks/${memberId}`) 
        .then(response => response.json())
        .then(data => {
            weekEditSelect.innerHTML = ''; // Kosongkan lagi setelah sukses fetch
            
            if (data && data.filled_weeks && data.filled_weeks.length > 0) {
                // Tambahkan opsi default
                const defaultOpt = document.createElement("option");
                defaultOpt.value = "";
                defaultOpt.text = "Pilih Minggu untuk Dihapus";
                defaultOpt.disabled = true;
                defaultOpt.selected = true;
                weekEditSelect.appendChild(defaultOpt);

                data.filled_weeks.forEach(item => {
                    const opt = document.createElement("option");
                    // Kirim nomor minggu (week) sebagai nilai
                    opt.value = item.week; 
                    // Tampilkan Minggu ke-X (Tanggal)
                    opt.text = `Minggu ke-${item.week}`; 
                    weekEditSelect.appendChild(opt);
                });
                deleteButton.disabled = false;
            } else {
                const opt = document.createElement("option");
                opt.value = "";
                opt.text = "Tidak ada riwayat tabungan yang dapat diedit.";
                opt.disabled = true;
                opt.selected = true;
                weekEditSelect.appendChild(opt);
                deleteButton.disabled = true;
            }
        })
        .catch(error => {
            console.error('Error fetching filled weeks:', error);
            weekEditSelect.innerHTML = '<option value="" disabled selected>Gagal memuat data riwayat.</option>';
            deleteButton.disabled = true;
        });
}

// Event listener untuk memastikan tombol Hapus hanya aktif jika opsi dipilih
weekEditSelect.addEventListener('change', function() {
    deleteButton.disabled = this.value === "";
});
</script>
{% endblock %}